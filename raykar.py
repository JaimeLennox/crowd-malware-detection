import data
import threshold
import numpy as np


def run_raykar(engine_count, data_dict, type_dict):

    print "Raykar Method:"

    # Initialise by majority voting
    mu = threshold.majority_vote(data_dict)

    # Initialisation
    R = engine_count
    N = len(data_dict)

    a1 = 3
    a2 = 2
    b1 = 3
    b2 = 2

    p1 = 2
    p2 = 2

    sensitivity = np.zeros(R)
    specificity = np.zeros(R)

    mu_diff = 1

    while mu_diff > 0:
        # EM iteration
        for j in range(R):
            sum_mu = sum([v if data_dict[k][j] < 2 else 0 for k, v in mu.iteritems()])
            sum_neg_mu = sum([(1 - v) if data_dict[k][j] < 2 else 0 for k, v in mu.iteritems()])

            sum_mu_y = sum([v * data_dict[k][j] if data_dict[k][j] < 2 else 0 for k, v in mu.iteritems()])
            sum_neg_mu_y = sum([(1 - v) * (1 - data_dict[k][j]) if data_dict[k][j] < 2 else 0 for k, v in mu.iteritems()])

            sensitivity[j] = (a1 - 1 + sum_mu_y) / float(a1 + a2 - 2 + sum_mu)
            specificity[j] = (b1 - 1 + sum_neg_mu_y) / float(b1 + b2 - 2 + sum_neg_mu)

        sum_mu = sum([v for v in mu.values()])
        prevalence = (p1 - 1 + sum_mu) / float(p1 + p2 - 2 + N)

        difference = dict(mu)

        for i in data_dict:

            log_a = 0
            log_b = 0

            indices = [index for index, x in enumerate(data_dict[i]) if x < 2]

            for j in indices:
                y = data_dict[i][j]
                log_a += np.log((sensitivity[j] ** y) * ((1 - sensitivity[j]) ** (1 - y)))
                log_b += np.log((specificity[j] ** (1 - y)) * ((1 - specificity[j]) ** y))

            a = np.exp(log_a)
            b = np.exp(log_b)

            mu[i] = int(round((a * prevalence) / (a * prevalence + (b * (1 - prevalence)))))
            difference[i] = abs(difference[i] - mu[i])

        mu_diff = sum(difference.values())

        accuracy = data.correct_count(mu, type_dict) / float(N)
        print accuracy


if __name__ == "__main__":
    engine_count, data_dict, type_dict = data.get_ransomware_data()
    run_raykar(engine_count, data_dict, type_dict)











