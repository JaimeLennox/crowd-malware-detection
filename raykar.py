import data
import threshold
import numpy as np


if __name__ == "__main__":
    engine_count, ransomware_dict, goodware_dict = data.get_data()

    # Initialise by majority voting
    mu = threshold.majority_vote(ransomware_dict, engine_count)

    # Initialisation
    R = engine_count
    N = len(ransomware_dict)

    epsilon = 0.001
    a = 0.5
    b = 0.5

    a1 = np.ones(R) * 0.5
    a2 = np.ones(R) * 0.5
    b1 = np.ones(R) * 0.5
    b2 = np.ones(R) * 0.5

    p1 = 0.5
    p2 = 0.5

    sensitivity = np.zeros(R)
    specificity = np.zeros(R)

    muDiff = 1
    count = 0

    while muDiff > epsilon:
        # EM iteration
        for j in range(R):
            sumMu = sum([v if ransomware_dict[k][j] != 2 else 0 for k, v in mu.iteritems()])
            sumNegMu = sum([(1 - v) if ransomware_dict[k][j] != 2 else 0 for k, v in mu.iteritems()])

            sumMuY = sum([v * ransomware_dict[k][j] if ransomware_dict[k][j] != 2 else 0 for k, v in mu.iteritems()])
            sumNegMuY = sum([(1 - v) * (1 - ransomware_dict[k][j]) if ransomware_dict[k][j] != 2 else 0 for k, v in mu.iteritems()])

            sensitivity[j] = (a1[j] - 1 + sumMuY) / (a1[j] + a2[j] - 2 + sumMu + epsilon)
            specificity[j] = (b1[j] - 1 + sumNegMuY) / (b1[j] + b2[j] - 2 + sumNegMu + epsilon)

        sumMu = sum([v for v in mu.values()])
        prevalence = (p1 - 1 + sumMu) / p1 + p2 - 2 + N

        a = {}
        b = {}
        difference = dict(mu)

        for i in ransomware_dict:
            a[i] = 1
            b[i] = 1

            indices = [index for index, x in enumerate(ransomware_dict[i]) if x == 0 or x == 1]

            for j in indices:
                y = ransomware_dict[i][j]
                a[i] = a[i] * (sensitivity[j] ** y) * ((1 - sensitivity[j]) ** (1 - y))
                b[i] = b[i] * (specificity[j] ** (1 - y)) * ((1 - specificity[j]) ** y)

            mu[i] = round((a[i] * prevalence) / (a[i] * prevalence + (b[i] * (1 - prevalence))))
            difference[i] = abs(difference[i] - mu[i])

        muDiff = sum(difference.values())

        accuracy = mu.values().count(1) / float(N)
        print accuracy











