import couchdb
import model


def get_engines(db):

    engines = set()

    count = 0

    for report in db:
        file_report = model.FileReport.load(db, report)
        for engine in file_report.scans:
            engines.add(engine)

        count += 1

        # should have gathered all engines by now
        if count == 1000:
            break

    return engines


def get_reports(db, engines):
    reports = []

    for report in db:
        file_report = model.FileReport.load(db, report)
        reports.append(transform_report(file_report, engines))

    return reports


def transform_report(report, engines):
    line = report.sha1 + ';'

    for engine in engines:
        av = report.scans.get(engine, 2)
        if av != 2:
            av = 1 if av['detected'] else 0

        line += str(av) + ';'

    return line


if __name__ == '__main__':
    server = couchdb.Server()
    malware_db = server['malware']

    engines = get_engines(malware_db)

    with open('engines.txt', 'w') as engines_file:
        for engine in engines:
            engines_file.write(engine + '\n')

    reports = get_reports(malware_db, engines)

    with open('reports.txt', 'w') as reports_file:
        for report in reports:
            print report
            reports_file.write(report + '\n')



