import couchdb

from utils import model


def get_engines(db):
    engines = set()

    for report in db:
        file_report = model.FileReport.load(db, report)
        for engine in file_report.scans:
            engines.add(engine)

    return engines


def get_reports(db, engines):
    reports = []

    for report in db:
        if report == '_design/views':
            continue
        file_report = model.FileReport.load(db, report)
        reports.append(transform_report(file_report, engines))

    return reports


def transform_report(report, engines):
    line = report.sha1 + ';'

    for engine in engines:
        av = report.scans.get(engine, 2)
        if av != 2:
            av = 1 if av['detected'] else 0

        line += str(av) + ';'

    return line


if __name__ == '__main__':
    server = couchdb.Server()

    malware_db_old = server['malware']
    malware_db_new = server['malware2']

    goodware_db_new = server['goodware2']

    engines_malware_old = get_engines(malware_db_old)

    with open('engines_malware_old.txt', 'w') as engines_file:
        for engine in engines_malware_old:
            engines_file.write(engine + '\n')

    engines_malware_new = get_engines(malware_db_new)

    with open('engines_malware_new.txt', 'w') as engines_file:
        for engine in engines_malware_new:
            engines_file.write(engine + '\n')

    engines_goodware_new = get_engines(goodware_db_new)

    with open('engines_goodware_new.txt', 'w') as engines_file:
        for engine in engines_goodware_new:
            engines_file.write(engine + '\n')

