import sys

if __name__ == '__main__':
    args = sys.argv[1:]

    if len(args) != 4:
        print "Usage: convert_goodware <goodware_analyzed_file> <engines_file> <output_engines_file> <output_file>"
        sys.exit(2)

    goodware_analyzed_file = args[0]
    input_engines_file = args[1]
    output_engines_file = args[2]
    output_file = args[3]

    with open(goodware_analyzed_file) as goodware_analyzed:
        lines = [line.rstrip(';\r\n') for line in goodware_analyzed]

    data_list = map(lambda x: x.split(';'), lines)

    engines = data_list[0]

    with open(output_engines_file, 'w') as engines_file:
        for engine in engines:
            engines_file.write(engine + "\n")

    data_dict = {}

    for data in data_list[1:]:
        data_dict[data[-1]] = map(int, data[:-1])

    with open(input_engines_file) as combined_engines_file:
        combined_engines = [engine.rstrip('\r\n') for engine in combined_engines_file]

    indexes = [engines.index(engine) if engine in engines else -1 for engine in combined_engines]

    lines = []

    for data in data_dict:
        line = data + ";"

        for engine in range(len(combined_engines)):
            if indexes[engine] == -1:
                line += "2;"
            else:
                line += str(data_dict[data][indexes[engine]]) + ";"

        lines.append(line)

    with open(output_file, 'w') as output:
        for line in lines:
            output.write(line + "\n")
