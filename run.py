import numpy as np
import os
from argparse import ArgumentParser

from algorithms import threshold, raykar, welinder_perona
from utils import data

if __name__ == "__main__":
    algorithm_choices = ["threshold", "majority_vote", "raykar_core", "raykar_supervised", "raykar_spammers", "raykar_annotators", "welinder_perona"]

    parser = ArgumentParser()

    subparsers = parser.add_subparsers()
    roc = subparsers.add_parser("roc", help="roc graph")
    roc.add_argument("-d", "--dataset", choices=["new", "old", "ransomware"], required=True, help="dataset to use")
    roc.add_argument("-v", "--verbose", action="store_true", help="increase output verbosity")

    algorithm = subparsers.add_parser("algorithm")
    algorithm.add_argument("-a", "--algorithm", choices=algorithm_choices, help="algorithm to use")
    algorithm.add_argument("-g", "--show-graphs", action="store_true", help="show graphs")
    algorithm.add_argument("-d", "--dataset", choices=["new", "old", "ransomware"], required=True, help="dataset to use")
    algorithm.add_argument("-v", "--verbose", action="store_true", help="increase output verbosity")

    args = parser.parse_args()

    datasets = {
        "new": data.get_new_large_data,
        "old": data.get_old_large_data,
        "ransomware": data.get_ransomware_data
    }

    engine_count, data_dict, type_dict = datasets[args.dataset]()
    raykar = raykar.Raykar(engine_count, data_dict, type_dict, show_graphs=args.show_graphs if "show_graphs" in args else False, verbose=args.verbose)
    welinder_perona = welinder_perona.WelinderPerona(engine_count, data_dict, type_dict)
    threshold = threshold.Threshold(data_dict, type_dict)

    algorithms = {
        "threshold": threshold.run_threshold,
        "majority_vote": threshold.run_majority_vote,
        "raykar_core": raykar.run_core_method,
        "raykar_supervised": raykar.run_semi_supervised_method,
        "raykar_spammers": raykar.run_spammers_method,
        "raykar_annotators": raykar.run_annotators_method,
        "welinder_perona": welinder_perona.run
    }

    if "algorithm" in args:
        algorithms[args.algorithm]()
    else:
        filename = "raykar_core" + "_" + args.dataset

        if os.path.exists(filename + ".npy"):
            results, prob_results = np.load(filename + ".npy")
        else:
            results, prob_results = raykar.run_core_method()
            np.save(filename, (results, prob_results))

        data.roc_results(prob_results[-1], type_dict)



